---
title: "Replication Analysis"
format: 
  pdf: default
  html:
    embed-resources: true
    toc: true
editor: visual
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(brms)
library(posterior)
library(glue)
library(tidybayes)

theme_set(theme_classic(base_size = 14))
```

## Load and Clean Data

```{r load_data}
file_path <- "results_prod-6.csv"
raw_lines <- readLines(file_path)
data_lines <- raw_lines[!grepl("^#", raw_lines)]
con <- textConnection(data_lines)
data <- read.csv(
    con,
    header = FALSE,
    fill = TRUE,
    col.names = paste0("V", 1:30),
    stringsAsFactors = FALSE
)
close(con)

clean_data <- data %>%
    filter(V16 == "experimental") %>%
    select(
        Part_ID = V13,
        Item_Set = V14,
        Trial_Order = V15,
        Condition1 = V17,
        Condition2 = V18,
        Correct_Resp = V19,
        Participant_Response = V20,
        RT = V21
    ) %>%
    distinct(Part_ID, Item_Set, Trial_Order, .keep_all = TRUE) %>%
    mutate(
        RT = as.numeric(as.character(RT)),
        Response_Binary = ifelse(Participant_Response == "Yes", 1, 0),
        Is_Correct = ifelse(Participant_Response == Correct_Resp, 1, 0),
        Condition1 = as.factor(Condition1),
        Condition2 = as.factor(Condition2)
    )
table(clean_data$Condition1, clean_data$Condition2)
```

## Descriptive Plots (Dots and Error Bars)

We plot the mean acceptance rate with standard error bars, consistent with the reference style.

```{r descriptive_plot, fig.width=6, fig.height=4}
desc_stats <- clean_data %>%
    group_by(Condition1, Condition2) %>%
    summarise(
        Mean = mean(Response_Binary, na.rm = TRUE),
        SE = sd(Response_Binary, na.rm = TRUE) / sqrt(n()),
        .groups = "drop"
    )

ggplot(
    desc_stats,
    aes(x = Condition1, y = Mean, color = Condition2, group = Condition2)
) +
    geom_errorbar(
        aes(ymin = Mean - SE, ymax = Mean + SE),
        width = 0.1,
        position = position_dodge(0.3)
    ) +
    geom_point(size = 3, position = position_dodge(0.3)) +
    scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
    labs(
        title = "Mean Acceptance by Condition",
        x = "Condition 1",
        y = "Acceptance Rate",
        color = "Condition 2"
    ) +
    theme(legend.position = "top")
```

## Bayesian Analysis

### Contrast Setup

We use Helmert-like orthonormal contrasts for the 3-level factor `Condition2`. Hypothesis: We want to compare levels in a structured way. Assumed Levels: `attractorMatch`, `noMatch`, `targetMatch`.

We define a custom contrast matrix. Contrast 1: `attractorMatch` vs `targetMatch` (ignoring `noMatch`). Contrast 2: `noMatch` vs Average of (`attractorMatch` & `targetMatch`).


```{r contrasts}
clean_data$Condition2 <- factor(
    clean_data$Condition2,
    levels = c("targetMatch", "attractorMatch", "noMatch")
)

c_mat <- matrix(
    c(
        -1,
        1,
        0,
        -1,
        -1,
        2
    ),
    ncol = 2
)


colnames(c_mat) <- c("Attr_vs_Targ", "No_vs_Matches")
contrasts(clean_data$Condition2) <- c_mat

contrasts(clean_data$Condition1) <- contr.sum(2)
colnames(contrasts(clean_data$Condition1)) <- c("Cond1_Diff")

print("Contrasts for Condition 2:")
print(contrasts(clean_data$Condition2))
```

### Model Fitting

Fitting a Bayesian logistic regression with random slopes for subjects and items. *Note: This might take time.*

```{r brms_model}

bf_mod <- bf(
    Response_Binary ~ Condition1 *
        Condition2 +
        (1 + Condition1 * Condition2 | Part_ID) +
        (1 + Condition1 * Condition2 | Item_Set)
)

priors <- c(
    set_prior("normal(0, 1)", class = "b"),
    set_prior("normal(0, 2)", class = "Intercept"),
    set_prior("lkj(2)", class = "cor")
)

fit <- brm(
    formula = bf_mod,
    data = clean_data,
    family = bernoulli(link = "logit"),
    prior = priors,
    chains = 4,
    iter = 2000,
    warmup = 1000,
    cores = 4,
    seed = 123,
    file = "brms_fit_replication"
)
```

### Results & Plotting

```{r model_results}

fixef(fit)

draws <- as_draws_df(fit)

cond_effects <- conditional_effects(fit, effects = "Condition1:Condition2")
plot(cond_effects, points = TRUE)
```

## Coefficient Plot (Replicating Paper Style)

```{r coef_plot_paper_style}

post_summary <- posterior_summary(fit, pars = "^b_") %>%
    as.data.frame() %>%
    rownames_to_column("Term") %>%
    filter(Term != "b_Intercept")

post_summary <- post_summary %>%
    mutate(
        Term = str_remove(Term, "b_"),
        Term = str_replace(Term, "Condition1", ""),
        Term = str_replace(Term, "Condition2", "")
    )

ggplot(post_summary, aes(y = Term, x = Estimate)) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = Q2.5, xmax = Q97.5), height = 0.2) +
    labs(
        title = "Bayesian Model Coefficients",
        x = "Estimate (Log Odds)",
        y = "Contrast"
    )
```